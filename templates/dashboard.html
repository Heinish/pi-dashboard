<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçì Raspberry Pi Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-warning {
            background: #f6ad55;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-info {
            background: #4299e1;
            color: white;
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .pi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .pi-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .pi-card:hover {
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }

        .pi-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .pi-name-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .pi-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3748;
        }

        .edit-name-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: #4299e1;
            padding: 5px;
            transition: all 0.2s;
        }

        .edit-name-btn:hover {
            color: #2c5282;
            transform: scale(1.1);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-online {
            background: #48bb78;
            box-shadow: 0 0 8px rgba(72, 187, 120, 0.6);
        }

        .status-offline {
            background: #f56565;
            box-shadow: 0 0 8px rgba(245, 101, 101, 0.6);
        }

        .pi-info {
            margin-bottom: 15px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f7fafc;
        }

        .info-label {
            color: #718096;
            font-weight: 600;
        }

        .info-value {
            color: #2d3748;
            font-family: 'Courier New', monospace;
        }

        .url-control {
            margin-bottom: 15px;
        }

        .url-control input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .url-control input:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .button-group button {
            flex: 1;
            min-width: 100px;
            font-size: 12px;
            padding: 8px 12px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .modal-header {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f7fafc;
            border-radius: 6px;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .empty-state h2 {
            font-size: 1.8em;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #718096;
            font-size: 1.1em;
        }

        /* Preview Modal Styles */
        .preview-modal .modal-content {
            max-width: 90%;
            max-height: 90vh;
            padding: 20px;
        }

        .preview-modal iframe {
            width: 100%;
            height: 70vh;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .close-btn {
            background: #f56565;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üçì Raspberry Pi Dashboard</h1>
            <p>Manage all your FullPageOS displays from one place</p>
        </header>

        <div class="controls">
            <button class="btn-primary" onclick="showAddPiModal()">‚ûï Add Pi</button>
            <button class="btn-success" onclick="refreshAll()">üîÑ Refresh</button>
            <button class="btn-warning" onclick="showBulkActions()">üìã Bulk Actions</button>
        </div>

        <div id="piGrid" class="pi-grid"></div>
    </div>

    <!-- Add Pi Modal -->
    <div id="addPiModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header">Add New Raspberry Pi</h2>
            <div class="form-group">
                <label for="piIp">IP Address</label>
                <input type="text" id="piIp" placeholder="e.g., 192.168.1.100">
            </div>
            <div class="form-group">
                <label for="piName">Friendly Name</label>
                <input type="text" id="piName" placeholder="e.g., Living Room Display">
            </div>
            <div class="button-group">
                <button class="btn-success" onclick="addPi()">Add</button>
                <button class="btn-secondary" onclick="closeModal('addPiModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Modal -->
    <div id="bulkModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header">Bulk Actions</h2>
            <div id="bulkPiList"></div>
            <div class="form-group">
                <label for="bulkUrl">New URL (for URL change)</label>
                <input type="text" id="bulkUrl" placeholder="https://example.com">
            </div>
            <div class="button-group">
                <button class="btn-info" onclick="bulkChangeUrl()">Change URLs</button>
                <button class="btn-warning" onclick="bulkRestartBrowser()">Restart Browsers</button>
                <button class="btn-secondary" onclick="closeModal('bulkModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal preview-modal">
        <div class="modal-content">
            <div class="preview-header">
                <h2 class="modal-header" id="previewTitle">Website Preview</h2>
                <button class="close-btn" onclick="closeModal('previewModal')">‚úï Close</button>
            </div>
            <iframe id="previewFrame" src="about:blank"></iframe>
        </div>
    </div>

    <script>
        let pis = [];

        async function loadPis() {
            try {
                const response = await fetch('/api/pis');
                pis = await response.json();
                renderPis();
                if (pis.length > 0) {
                    updateAllStatuses();
                }
            } catch (error) {
                console.error('Error loading Pis:', error);
            }
        }

        function renderPis() {
            const grid = document.getElementById('piGrid');
            
            if (pis.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h2>No Raspberry Pis Added</h2>
                        <p>Click "‚ûï Add Pi" to get started!</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = pis.map(pi => `
                <div class="pi-card" id="pi-${pi.ip.replace(/\./g, '-')}">
                    <div class="pi-header">
                        <div class="pi-name-container">
                            <span class="status-indicator status-offline" id="status-${pi.ip.replace(/\./g, '-')}"></span>
                            <span class="pi-name" id="name-${pi.ip.replace(/\./g, '-')}">${pi.name}</span>
                            <button class="edit-name-btn" onclick="editPiName('${pi.ip}')" title="Edit name">‚úèÔ∏è</button>
                        </div>
                    </div>
                    <div class="pi-info" id="info-${pi.ip.replace(/\./g, '-')}">
                        <div class="info-row">
                            <span class="info-label">IP:</span>
                            <span class="info-value">${pi.ip}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Status:</span>
                            <span class="info-value">Checking...</span>
                        </div>
                    </div>
                    <div class="url-control">
                        <input type="text" 
                               id="url-${pi.ip.replace(/\./g, '-')}" 
                               placeholder="Enter new URL"
                               value="">
                        <div class="button-group">
                            <button class="btn-info" onclick="setUrl('${pi.ip}')">Set URL</button>
                            <button class="btn-success" onclick="previewUrl('${pi.ip}')">üëÅÔ∏è Preview</button>
                        </div>
                    </div>
                    <div class="button-group">
                        <button class="btn-warning" onclick="restartBrowser('${pi.ip}')">Restart Browser</button>
                        <button class="btn-danger" onclick="rebootPi('${pi.ip}')">Reboot</button>
                        <button class="btn-secondary" onclick="removePi('${pi.ip}')">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        async function updatePiStatus(ip) {
            const statusId = `status-${ip.replace(/\./g, '-')}`;
            const infoId = `info-${ip.replace(/\./g, '-')}`;
            const urlInputId = `url-${ip.replace(/\./g, '-')}`;
            
            try {
                const response = await fetch(`/api/pis/${ip}/status`);
                const data = await response.json();
                
                const statusEl = document.getElementById(statusId);
                const infoEl = document.getElementById(infoId);
                const urlInput = document.getElementById(urlInputId);
                
                if (data.online) {
                    statusEl.className = 'status-indicator status-online';
                    const status = data.status;
                    
                    infoEl.innerHTML = `
                        <div class="info-row">
                            <span class="info-label">IP:</span>
                            <span class="info-value">${ip}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Current URL:</span>
                            <span class="info-value">${status.current_url || 'Unknown'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Uptime:</span>
                            <span class="info-value">${status.uptime || 'Unknown'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">CPU:</span>
                            <span class="info-value">${status.cpu_usage || 'N/A'}%</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Memory:</span>
                            <span class="info-value">${status.memory || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Temp:</span>
                            <span class="info-value">${status.temperature || 'N/A'}</span>
                        </div>
                    `;
                    
                    if (urlInput && status.current_url) {
                        urlInput.value = status.current_url;
                    }
                } else {
                    statusEl.className = 'status-indicator status-offline';
                    infoEl.innerHTML = `
                        <div class="info-row">
                            <span class="info-label">IP:</span>
                            <span class="info-value">${ip}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Status:</span>
                            <span class="info-value" style="color: #f56565;">Offline</span>
                        </div>
                    `;
                }
            } catch (error) {
                console.error(`Error updating status for ${ip}:`, error);
            }
        }

        async function updateAllStatuses() {
            for (const pi of pis) {
                await updatePiStatus(pi.ip);
            }
        }

        function showAddPiModal() {
            document.getElementById('addPiModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'previewModal') {
                document.getElementById('previewFrame').src = 'about:blank';
            }
        }

        async function addPi() {
            const ip = document.getElementById('piIp').value.trim();
            const name = document.getElementById('piName').value.trim() || ip;
            
            if (!ip) {
                alert('Please enter an IP address');
                return;
            }
            
            try {
                const response = await fetch('/api/pis', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ip, name})
                });
                
                const data = await response.json();
                if (data.success) {
                    closeModal('addPiModal');
                    document.getElementById('piIp').value = '';
                    document.getElementById('piName').value = '';
                    await loadPis();
                } else {
                    alert(data.error || 'Failed to add Pi');
                }
            } catch (error) {
                alert('Error adding Pi: ' + error.message);
            }
        }

        async function removePi(ip) {
            if (!confirm(`Remove ${ip} from dashboard?`)) return;
            
            try {
                await fetch(`/api/pis/${ip}`, {method: 'DELETE'});
                await loadPis();
            } catch (error) {
                alert('Error removing Pi: ' + error.message);
            }
        }

        async function editPiName(ip) {
            const currentName = pis.find(p => p.ip === ip)?.name || ip;
            const newName = prompt('Enter new name:', currentName);
            
            if (newName && newName !== currentName) {
                try {
                    await fetch(`/api/pis/${ip}/name`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({name: newName})
                    });
                    await loadPis();
                } catch (error) {
                    alert('Error updating name: ' + error.message);
                }
            }
        }

        async function setUrl(ip) {
            const urlInput = document.getElementById(`url-${ip.replace(/\./g, '-')}`);
            const url = urlInput.value.trim();
            
            if (!url) {
                alert('Please enter a URL');
                return;
            }
            
            try {
                const response = await fetch(`/api/pis/${ip}/url`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({url})
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('URL updated successfully!');
                    await updatePiStatus(ip);
                } else {
                    alert('Failed to update URL: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error updating URL: ' + error.message);
            }
        }

        async function previewUrl(ip) {
            const urlInput = document.getElementById(`url-${ip.replace(/\./g, '-')}`);
            const url = urlInput.value.trim();
            
            if (!url) {
                alert('Please enter a URL first');
                return;
            }
            
            const piName = pis.find(p => p.ip === ip)?.name || ip;
            document.getElementById('previewTitle').textContent = `Preview: ${piName}`;
            document.getElementById('previewFrame').src = url;
            document.getElementById('previewModal').style.display = 'block';
        }

        async function restartBrowser(ip) {
            if (!confirm('Restart browser on this Pi?')) return;
            
            try {
                const response = await fetch(`/api/pis/${ip}/restart-browser`, {
                    method: 'POST'
                });
                const data = await response.json();
                alert(data.message || 'Browser restart command sent');
            } catch (error) {
                alert('Error restarting browser: ' + error.message);
            }
        }

        async function rebootPi(ip) {
            if (!confirm('‚ö†Ô∏è Reboot this entire Pi? This will take about 30-60 seconds.')) return;
            
            try {
                const response = await fetch(`/api/pis/${ip}/reboot`, {
                    method: 'POST'
                });
                const data = await response.json();
                alert(data.message || 'Reboot command sent');
                setTimeout(() => updatePiStatus(ip), 5000);
            } catch (error) {
                alert('Error rebooting Pi: ' + error.message);
            }
        }

        function showBulkActions() {
            const modal = document.getElementById('bulkModal');
            const list = document.getElementById('bulkPiList');
            
            list.innerHTML = `
                <div class="checkbox-item">
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    <label for="selectAll"><strong>Select All</strong></label>
                </div>
                ${pis.map(pi => `
                    <div class="checkbox-item">
                        <input type="checkbox" class="pi-checkbox" value="${pi.ip}" id="check-${pi.ip.replace(/\./g, '-')}">
                        <label for="check-${pi.ip.replace(/\./g, '-')}">${pi.name} (${pi.ip})</label>
                    </div>
                `).join('')}
            `;
            
            modal.style.display = 'block';
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.pi-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        function getSelectedPis() {
            return Array.from(document.querySelectorAll('.pi-checkbox:checked')).map(cb => cb.value);
        }

        async function bulkChangeUrl() {
            const selectedIps = getSelectedPis();
            const url = document.getElementById('bulkUrl').value.trim();
            
            if (selectedIps.length === 0) {
                alert('Please select at least one Pi');
                return;
            }
            
            if (!url) {
                alert('Please enter a URL');
                return;
            }
            
            if (!confirm(`Change URL to "${url}" on ${selectedIps.length} Pi(s)?`)) return;
            
            try {
                const response = await fetch('/api/bulk/url', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ips: selectedIps, url})
                });
                
                const data = await response.json();
                const successful = data.results.filter(r => r.success).length;
                alert(`Updated ${successful} of ${selectedIps.length} Pi(s)`);
                closeModal('bulkModal');
                await updateAllStatuses();
            } catch (error) {
                alert('Error in bulk update: ' + error.message);
            }
        }

        async function bulkRestartBrowser() {
            const selectedIps = getSelectedPis();
            
            if (selectedIps.length === 0) {
                alert('Please select at least one Pi');
                return;
            }
            
            if (!confirm(`Restart browsers on ${selectedIps.length} Pi(s)?`)) return;
            
            try {
                const response = await fetch('/api/bulk/restart-browser', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ips: selectedIps})
                });
                
                const data = await response.json();
                const successful = data.results.filter(r => r.success).length;
                alert(`Restarted ${successful} of ${selectedIps.length} browser(s)`);
                closeModal('bulkModal');
            } catch (error) {
                alert('Error in bulk restart: ' + error.message);
            }
        }

        function refreshAll() {
            updateAllStatuses();
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                if (event.target.id === 'previewModal') {
                    document.getElementById('previewFrame').src = 'about:blank';
                }
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(updateAllStatuses, 30000);

        // Load on page load
        loadPis();
    </script>
</body>
</html>
